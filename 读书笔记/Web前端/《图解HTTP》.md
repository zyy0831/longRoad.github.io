初版编者：:watermelon: 洋

名词解释

- 客户端（ Client ） ： 请求访问文本或图像等资源的一端 

- 服务器端（ Server ）：提供资源响应的一端

- HTTP（Hyper Text Transfer Protocol，超文本传输协议）:  请求-响应协议 , 指定了客户端可能发送给服务器什么样的消息以及得到什么样的响应。 

-----------------------

# 《图解HTTP》

---------------------

[TOC]

## 第一章 了解Web及网络基础

### **1.1 使用HTTP协议访问Web**

Web使用 HTTP 作为规范，完成从 C 端到 S 端的一系列运作流程。

### **1.2 HTTP的诞生**

- 1989年，HTTP诞生，实现通过互联网，多文档之间传输。

- 1990年，CERN 成功研发了世界上第一台 Web 服务器和 Web 浏览器。 

- 1994年，网景公司Netscape Navigator 1.0 。

- 1995年，微软 Internet Explorer 1.0 和 2.0。 当前的Web 服务器标准 Apache出现。HTML 2.0发布。

第一次浏览器大战（1995-2000）：微软公司与网景通信公司 ， 都各自对 HTML做了扩展 ， 导致在写 HTML页面时，必须考虑兼容他们两家公司的浏览器。

- 2004年， Mozilla 基金会发布了 Firefox 浏览器 。随之，第二次浏览器大战。

而HTTP自1990年问世，仅发展到2.0版本，却广泛应用到各种应用场景之中。

### **1.3  网络基础 TCP/IP 协议族**

- HTTP 属于TCP/IP 内部的一个子集 。

- 协议： 计算机与网络设备相互通信的规则。

- TCP/IP 协议族按层次分别分为 4 层

  - 应用层  FTP 、 DNS、 HTTP 

    （ 决定了向用户提供应用服务时通信的活动 ）例如发送 HTTP 请求 

  - 传输层 TCP 、 UDP 

    （ 网络连接中的两台计算机之间的数据传输 ） 把从应用层处收到的数 据（HTTP 请求报文）进行分割，并在各个报文上打上标记序号及端 口号后（+ TCP首部）转发给网络层。 

  - 网络层 IP  

    （ 规定了通过怎样的路径到达对方计算机，并把数据包传送给对方 ） 增加作为通信目的地的 MAC 地址后转发给链路层  （+IP首部）

  - 数据链路层

    （ 用来处理连接网络的硬件部分 ）（+以太网首部）

### **1.4  与 HTTP 关系密切的协议 : IP、TCP 和 DNS**  

- IP（Internet Protocol）网际协议

  - 位于网络层， 作用是把各种数据包传送给对方。

  - 其中两个重要的先决条件需要被满足
  - IP 地址
    -  MAC 地址（Media Access Control Address）

  - IP 地址可变换，但 MAC 地址基本上不会更改。

  - IP 间的通信依赖 MAC 地址
    - 网络通信一般需要经过多台计算机和网络设备中转，不断利用下一站中转设备的 MAC 地址来搜索下一个中转目标，并采用 ARP 协议（Address Resolution Protocol）
    - ARP 是一种用以解析地址的协议，根据通信方 的 IP 地址就可以反查出对应的 MAC 地址。  
    - 这种机制叫路由选择  （routing） 

- TCP 协议 （确保可靠性）

  - TCP 协议 

    位于传输层，提供可靠的字节流服务，

    即保证 数据准确可靠地传给对方，确认数据最终是否送达。

  - **TCP 协议采用了三次握手 （three-way handshaking）策略** 

    - 发送端首先发送一个带 SYN 标志的数据包给对方。
    - 接收端收到后， 回传一个带有 SYN/ACK 标志的数据包以示传达确认信息。
    - 最后，发送端再回传一个带 ACK 标志的数据包，代表“握手”结束。 

### **1.5 负责域名解析的 DNS 服务** 

- DNS（Domain Name System）

  - 和 HTTP 协议一样位于应用层的协议。

  - DNS 协议提供通过域名 查找 IP 地址（域名到 IP 地址之间的解析服务），

    或逆向从 IP 地址反查域名的服务。 

###  **1.6** 种协议与 HTTP 协议的关系 

###  1.7  URI 和 URL

-------------------------------------

## **第 2 章 简单的 HTTP 协议** 

### **2.1 HTTP 协议用于客户端和服务器端之间的通信** 

用 HTTP 协议能够明确区分哪端是客户端，哪端是服务器端 。

HTTP 协议规定，请求从客户端发出，最后服务器端响应该请求并返回。 

###  **2.2 通过请求和响应的交换达成通信** 

- 请求报文
  - 请求方法（GET、POST等）
  - 请求 URI（xx/xx.html）、
  - 协议版本（HTTP 1.1）、
  - 可选的请求首部字段（Content-Type等）
  - 内容实体（传入的参数）。

- 响应
  - 服务器对应的 HTTP 版本 （HTTP 1.1）、  
  - 表示请求的处理结果的状态码 （200 ）、 
  - 用以解释状态码的原因短语 （OK）、  
  - 可选的响应首部字段（Date、Content-Type等）
  - 实体主体。 

### **2.3 HTTP 是不保存状态的协议** 

- HTTP 是一种不保存状态，即无状态（stateless）协议。 
- HTTP  协议对于发送过的请求或响应都不做持久化处理。 

- 使用 HTTP 协议，每当有新的请求发送时，就会有对应的新响应产 生。
- 协议本身并不保留之前一切的请求或响应报文的信息。 

HTTP/1.1 虽然是无状态协议，但为了实现期望的保持状态功能，于 是引入了 Cookie 技术。 

### **2.4 请求 URI 定位资源** 

- 当客户端请求访问资源而发送请求时，URI 需要将作为请求报文中的 请求 URI 包含在内。  
- 如果不是访问特定资源而是对服务器本身发起请求，可以 用一个 * 来代替请求 URI。 

### **2.5 告知服务器意图的 HTTP 方法** 

- GET ：获取资源 

- POST：传输实体主体 

- PUT：传输文件 
- DELETE：删除文件 

- HEAD：获得报文首部 ； OPTIONS：询问支持的方法 ； TRACE：追踪路径 ； CONNECT：要求用隧道协议连接代理 

### **2.6 使用方法下达命令** 

### **2.7 持久连接节省通信量** 

HTTP 协议的初始版本中，每进行一次 HTTP 通信就要断开一次 TCP 连接。造成每次的请求都产生无谓的 TCP 连接建立和断开，增加通信量的开销。

持久连接：为解决上述 TCP 连接的问题，HTTP/1.1 和一部分的 HTTP/1.0 想出了持久连接（HTTP Persistent Connections，也称为 HTTP keep-alive 或HTTP connection reuse）的方法。

- 特点：只要任意一端没有明确提出断开连接，则保持 TCP 连接状态。
- 优势：在于减少了 TCP 连接的重复建立和断开所造成的额外开销，减轻了服务器端的负载，并使HTTP 请求和响应能够更早地结束，这样 Web 页面的显示速度也就相应提高了。

管线化：同时并行发送多个请求，而不需要一个接一个地等待响应

### **2.8 使用 Cookie 的状态管理**

HTTP 是无状态协议，它不对之前发生过的请求和响应的状态进行管理。

假设要求登录认证的 Web 页面本身无法进行状态的管理（不记录已登录的状态），那么每次跳转新页面不是要再次登录，就是要在每次请求报文中附加参数来管理登录状态。

Cookie 技术

- 通过在请求和响应报文中写入 Cookie 信息来控制客户端的状态。

- Cookie 会根据从服务器端发送的响应报文内的一个叫做 Set-Cookie 的首部字段信息，通知客户端保存 Cookie。当下次客户端再往该服务器发送请求时，客户端会自动在请求报文中加入 Cookie 值后发送出去。

----------------------

## **第 3 章 HTTP 报文内的 HTTP 信息**

### **3.1 HTTP 报文**

用于 HTTP 协议交互的信息。

- 请求报文：请求端（客户端）的HTTP 报文
- 响应报文：响应端（服务器端）的HTTP 报文

### **3.2 请求报文及响应报文的结构**

- 请求行：包含用于请求的方法，请求 URI 和 HTTP 版本。

- 状态行：包含表明响应结果的状态码，原因短语和 HTTP 版本。

- 首部字段：包含表示请求和响应的各种条件和属性的各类首部。
  一般有 4 种首部，分别是
  - 通用首部
  - 请求首部
  - 响应首部
  - 实体首部
  - 其他，可能包含 HTTP 的 RFC 里未定义的首部（Cookie 等）。

### **3.3 编码提升传输速率**

- 报文主体和实体主体的差异

  - 报文（message）：HTTP 通信中的基本单位，由 8 位组字节流（octet sequence，其中 octet 为 8 个比特）组成，通过 HTTP 通信传输。

  - 实体（entity）：作为请求或响应的有效载荷数据（补充项）被传输，其内容由实体首部和实体主体组成。
  - HTTP 报文的主体用于传输请求或响应的实体主体

- 压缩传输的内容编码：
  - 应用在实体内容上的编码格式，并保持实体信息原样压缩。内容编码后的实体由客户端接收并负责解码。
    gzip（GNU zip）、compress（UNIX 系统的标准压缩）、deflate（zlib）、identity（不进行编码）
  - 分割发送的分块传输编码：
    实体主体分块，每一块都会用十六进制来标记块的大小，而实体主体的最后一块会使用“0(CR+LF)”来标记。

### **3.4 发送多种数据的多部分对象集合**

- MIME（Multipurpose Internet Mail Extensions，多用途因特网邮件扩展）机制

  它允许邮件处理文本、图片、视频等多个不同类型的数据。

- 对象集合（Multipart）

  在MIME 扩展中使用，来容纳多份不同类型的数据。

HTTP 协议中也采纳了<u>多部分对象集合</u>，发送的一份报文主体内可含有多类型实体。

<u>多部分对象集合</u>包含的对象如下（HTTP 报文中，首部字段里加上Content-type）

- multipart/form-data  在 Web 表单文件上传时使用
- multipart/byteranges  

### **3.5 获取部分内容的范围请求**

想要实现从之前下载中断处恢复下载，需要指定下载的实体范围。

- 范围请求（Range Request）

  指定范围发送的请求

- 首部字段 Range 

  执行范围请求时，会用到来指定资源的 byte 范围。

- 206 Partial Content

  针对范围请求，响应会返回206状态码为的响应报文。

- ContentType: multipart/byteranges 

  对于多重范围的范围请求，响应会在首部字段  标明 后返回响应报文。

如果服务器端无法响应范围请求，则会返回状态码 200 OK 和完整的实体内容。

### **3.6 内容协商返回最合适的内容**

内容协商（Content Negotiation）

- 例如访问相同 URI 的 Web 页面时，会显示对应的英语版或中文版的 Web 页面。

- 指客户端和服务器端就响应的资源内容进行交涉，然后提供给客户端最为适合的资源。
- 内容协商会以响应资源的语言、字符集、编码方式等作为判断的基准。

包含在请求报文中的某些首部字段（如下）就是判断的基准

- Accept、Accept-Charset、Accept-Encoding、Accept-Language、Content-Langu

内容协商技术有以下 3 种类型 

- 服务器驱动协商（Server-driven Negotiation）以请求的首部字段为参考，在服务器端自动处理。

- 客户端驱动协商（Agent-driven Negotiation）用户从浏览器显示的可选项列表中手动选择。

- 透明协商（Transparent Negotiation）是由服务器端和客户端各自进行内容协商的一种方法。

## **第 4 章 返回结果的 HTTP 状态码**

HTTP 状态码负责表示客户端 HTTP 请求的返回结果、标记服务器端的处理是否正常、通知出现的错误等工作

### **4.1 状态码告知从服务器端返回的请求结果**

状态码的职责是当客户端向服务器端发送请求时，描述返回的请求结果。

借助状态码，用户可以知道服务器端是正常处理了请求，还是出现了错误。

响应类别有以下 5种。如图

常使用的大概只有 14 种。

- 2XX 成功：表明请求被正常处理了。

  - 200 OK 

    表示从客户端发来的请求在服务器端被正常处理了 

  - 204 No Conten 

    代表服务器接收的请求已成功处理，但在返回的响应报文中 不含实体的主体部分。

    - 比如， 当从浏览器发出请求处理后，返回 204 响应，那么浏览器显示的页面 不发生更新。 

    - 一般在只需要从客户端往服务器发送信息，而对客户端不需要发送新 信息内容的情况下使用。  

  - 206 Partial Content 

    表示客户端进行了范围请求，而服务器成功执行了这部分的 GET 请求。 

    响应报文中包含由 Content-Range 指定范围的实体内容。 

- 3XX 重定向 ： 表明浏览器需要执行某些特殊的处理以正确处理请求

  - 301 Moved Permanently   永久性重定向 

    表示请求的资源已被分配了新的 URI，以后 应使用资源现在所指的 URI。 

    URI已更新，需要更新引用

  - 302 Found   临时性重定向。 

    表示请求的资源已被分配了新的 URI，希望 用户（本次）能使用新的 URI 访问。 

    与301区别，302 状态码代表的资源不 是被永久移动，只是临时性质的 

  - 303 See Other 

    表示由于请求对应的资源存在着另一个 URI，应使用 GET 方法定向获取请求的资源。  

     与302区别，和 302 Found 状态码有着相同的功能，但 303 状态码明确 表示客户端应当采用 GET 方法获取资源 

  - 304 Not Modified 

    表示客户端发送附带条件（if-）的请求 时，服务器端允许请求访问资源，但未满足条件的情况。 

  - 307 Temporary Redirect  临时重定向

    该状态码与 302 Found 有着相同的含义 ， 307 会遵照浏览器标准，不会从 POST 变成 GET 

    

- 4XX 客户端错误 ： 表明客户端是发生错误的原因所在 

  -  400 Bad Request 

- 401 Unauthorized 

  -  403 Forbidden

- 404 Not Found 



## 第 5 章 与 HTTP 协作的 Web 服务器 

###  5.1 用单台虚拟主机实现多个域名 

-  HTTP/1.1 规范允许一台 HTTP 服务器搭建多个 Web 站点。  即使物理层面只有一台服务器，但只要使用虚拟主机的功能，则可以假想已具有多台服务器。（ 相同的 IP 地址 ，  虚拟主机可以寄存多个不同主机名和域名的 Web 网站 ）
-  如果一台服务器内托管了 www.tricorder.jp 和 www.hackr.jp 这两个域名，当收到请求时就需要弄清楚究竟要访问哪个域名。 （ DNS解析出 IP地址相同）
-  因此在发送 HTTP 请求时，必须在 Host 首部内完整指定主机名或域名的 URI。 

###  5.2 通信数据转发程序：代理、网关、隧道 

- 代理 

  是一种有转发功能的应用程序 ， 接收由客户端发送的请求并转发给服务器，同时也接收服务器返回的响应并转发给客户端 。

  - 持有资源实体的服务器被称为源服务器。从源服务器返回的响应经过代理服务器后再传给客户端。 
  -  在 HTTP 通信过程中，可级联多台代理服务器。 

- 网关

   是转发其他服务器通信数据的服务器 ， 接收从客户端发送来的请求时，它就像自己拥有资源的源服务器一样对请求进行处理。 

  -  网关的工作机制和代理十分相似。而网关能使通信线路上的服务器提供非 HTTP 协议服务 
  -  利用网关能提高通信的安全性，因为可以在客户端与网关之间的通信线路上加密以确保连接的安全。 
  -  比如，网关可以连接数据库，使用SQL 语句查询数据。 

- 隧道

    在相隔甚远的客户端和服务器两者之间进行中转，并保持双方通信连接的应用程序。 

  -  隧道可按要求建立起一条与其他服务器的通信线路，届时使用 SSL 等加密手段进行通信。
  -  隧道的目的是确保客户端能与服务器进行安全的通信。

###  5.3 保存资源的缓存 



## 第 6 章 HTTP 首部 





##  第 7 章 确保 Web 安全的 HTTPS

##  **7.1 HTTP 的缺点** 

- 通信使用明文（不加密），内容可能会被窃听 

  - 窃听 ： 

    收集在互联网上流动的数 据包（帧） 

    对于收集来的数据包的解析，例如抓包（Packet Capture）或嗅探器（Sniffer）工具 

  - 通信的加密 

    方法：和 SSL（Secure Socket Layer，安全套接层）或 TLS（Transport Layer Security，安全层传输协议）的组合使用， 加密 HTTP 的通信内容。 

    用 SSL建立安全通信线路之后，就可以在这条线路上进行 HTTP 通信了。与 SSL组合使用的 HTTP 被称为 **HTTPS**（HTTP Secure，超文本传输安全协议）或 HTTP over SSL。 

  - 内容的加密 ：

    方法： 把 HTTP 报文里所含的内容（报文主体）进行加密处理。

     前提是要求客户端和服务器同 时具备加密和解密机制。  仍有被篡改的风险 

- 不验证通信方的身份，因此有可能遭遇伪装 

  HTTP 协议中的请求和响应不会对通信方进行确认。  不论是谁发送过来的请求都会 返回响应

  -  无法确定请求发送至目标的 Web 服务器是否是按真实意 图返回响应的那台服务器。 
  -  无法确定响应返回到的客户端是否是按真实意图接收响 应的那个客户端。 
  -  无法确定正在通信的对方是否具备访问权限。 
  -  无法判定请求是来自何方、出自谁手。 
  -  即使是无意义的请求也会照单全收。  DoS 攻击（Denial of Service，拒绝服务攻击） 

- 无法证明报文的完整性，所以有可能已遭篡改 

- 存在脆弱性或安全漏洞 

  













 
